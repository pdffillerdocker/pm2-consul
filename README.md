# <a name="tags"></a>Supported tags and respective `Dockerfile` links

[dockerfile-6.17.1]:    https://github.com/pdffillerdocker/pm2-consul/blob/a45c4b552ea4add3d6be59471b260b672b41a0a7/Dockerfile
[dockerfile-8.9.4]:     https://github.com/pdffillerdocker/pm2-consul/blob/028d4ec122533a00b5f62e9edd5f8e78ba2d4da4/Dockerfile
[dockerfile-8.16.1]:    https://github.com/pdffillerdocker/pm2-consul/blob/f652793de341217f56c1a6b6864205898963e86b/Dockerfile
[dockerfile-8.16.1-1]:  https://github.com/pdffillerdocker/pm2-consul/blob/e2757c3de6a19b7a67b105acb2fe18b71bd424ba/Dockerfile
[dockerfile-8.16.1-2]:  https://github.com/pdffillerdocker/pm2-consul/blob/13447ee8d1b985940bb06c64f3fa32138f8c6f5f/Dockerfile
[dockerfile-10.1.0]:    https://github.com/pdffillerdocker/pm2-consul/blob/00daf799b4eeaae79bfc0d98288a08c09e2d1419/Dockerfile
[dockerfile-10.1.0-1]:  https://github.com/pdffillerdocker/pm2-consul/blob/bf00d7ea8a06fb03ab336444eb37419b0a8bf0c1/Dockerfile
[dockerfile-10.1.0-2]:  https://github.com/pdffillerdocker/pm2-consul/blob/0e0bab2e48d013b5cd65e243ccf474aa7a82f35b/Dockerfile
[dockerfile-10.12.0]:   https://github.com/pdffillerdocker/pm2-consul/blob/21f20c0915dc530087be8cfaa3d8c9f1ae749da4/Dockerfile
[dockerfile-10.12.0-1]: https://github.com/pdffillerdocker/pm2-consul/blob/acedb95b157e0b0a82238655f8c9b93e75f38c97/Dockerfile
[dockerfile-10.12.0-2]: https://github.com/pdffillerdocker/pm2-consul/blob/99dd664f40cb56450026a42b4c5d804925748800/Dockerfile
[dockerfile-10.16.0]:   https://github.com/pdffillerdocker/pm2-consul/blob/4559b658c38462f0038929480d74937ac48df485/Dockerfile
[dockerfile-10.16.0-1]: https://github.com/pdffillerdocker/pm2-consul/blob/b7aef2179f5754ad0a3369e3c2b63e8753f0f880/Dockerfile
[dockerfile-10.16.3]:   https://github.com/pdffillerdocker/pm2-consul/blob/67c1333743bed9d10056fdcbecbc82f77730bebf/Dockerfile
[dockerfile-10.16.3-1]: https://github.com/pdffillerdocker/pm2-consul/blob/4d113fa195f61608aff80e7a351f9aa0486b0e31/Dockerfile
[dockerfile-10.16.3-2]: https://github.com/pdffillerdocker/pm2-consul/blob/d991284c8a17b69f0e2bc3096207eb4c4a3772a9/Dockerfile
[dockerfile-10.21.0]:   https://github.com/pdffillerdocker/pm2-consul/blob/295bb610bf46966d886d32c902fb23ee13f3933b/Dockerfile
[dockerfile-12.8.1]:    https://github.com/pdffillerdocker/pm2-consul/blob/f7ad3fe8ad436c3e7babea970ed60fa9812d5f27/Dockerfile
[dockerfile-12.8.1-1]:  https://github.com/pdffillerdocker/pm2-consul/blob/5b204ea977f65750af3436e678eec6f0ea93c4f2/Dockerfile
[dockerfile-12.8.1-2]:  https://github.com/pdffillerdocker/pm2-consul/blob/9aa50e1cc32be2f27d3dad23b144dfe1b2bdb4cc/Dockerfile
[dockerfile-12.9.1]:    https://github.com/pdffillerdocker/pm2-consul/blob/15c0ccbe6b367c7a555e79322fbc5d7d1b005ce0/Dockerfile
[dockerfile-12.10.0]:   https://github.com/pdffillerdocker/pm2-consul/blob/487fd81ef9cb3516e14d24a66c9339f042102d56/Dockerfile
[dockerfile-12.16.2]:   https://github.com/pdffillerdocker/pm2-consul/blob/203ef5507bc4540dc5253870ae4dc80ee249089d/Dockerfile
[dockerfile-12.16.2-1]: https://github.com/pdffillerdocker/pm2-consul/blob/537faac1f956d5a416904bed0e16ba9500b0c3f0/Dockerfile
[dockerfile-12.18.2]:   https://github.com/pdffillerdocker/pm2-consul/blob/4866fec8cbc98c667506002eb08119b710699618/Dockerfile
[dockerfile-14.5.0]:    https://github.com/pdffillerdocker/pm2-consul/blob/21117f079d636f8afd9c3f39503cd6d8fbd4a82e/Dockerfile
[dockerfile-14.15.1]:   https://github.com/pdffillerdocker/pm2-consul/blob/c05ae3bb7ef34734e08284a6ddcd52a94ef1138b/Dockerfile

## <a name="tags-frozen"></a>Immutable (fixed, "frozen") tags

Tags that were once built and should not be rebuilt

-	[`6.17.1`][dockerfile-6.17.1]
-	[`8.9.4`][dockerfile-8.9.4],
	[`8.16.1`][dockerfile-8.16.1],
	[`8.16.1-1`][dockerfile-8.16.1-1],
	[`8.16.1-2`][dockerfile-8.16.1-2]
-	[`10.1.0`][dockerfile-10.1.0],
	[`10.1.0-1`][dockerfile-10.1.0-1],
	[`10.1.0-2`][dockerfile-10.1.0-2],
	[`10.12.0`][dockerfile-10.12.0],
	[`10.12.0-1`][dockerfile-10.12.0-1],
	[`10.12.0-2`][dockerfile-10.12.0-2],
	[`10.16.0`][dockerfile-10.16.0],
	[`10.16.0-1`][dockerfile-10.16.0-1],
	[`10.16.3`][dockerfile-10.16.3],
	[`10.16.3-1`][dockerfile-10.16.3-1],
	[`10.16.3-2`][dockerfile-10.16.3-2],
	[`10.21.0`][dockerfile-10.21.0]
-	[`12.8.1`][dockerfile-12.8.1],
	[`12.8.1-1`][dockerfile-12.8.1-1],
	[`12.8.1-2`][dockerfile-12.8.1-2],
	[`12.9.1`][dockerfile-12.9.1],
	[`12.10.0`][dockerfile-12.10.0],
	[`12.16.2`][dockerfile-12.16.2],
	[`12.16.2-1`][dockerfile-12.16.2-1],
	[`12.18.2`][dockerfile-12.18.2]
-	[`14.5.0`][dockerfile-14.5.0],
	[`14.15.1`][dockerfile-14.15.1]


## <a name="tags-stable"></a>Mutable tags

Tags that can point to different images over time

-	[`6.17`, `6`][dockerfile-6.17.1]
-	[`8.9`][dockerfile-8.9.4],
	[`8.16`, `8`][dockerfile-8.16.1-2]
-	[`10.1`][dockerfile-10.1.0-2],
	[`10.12`][dockerfile-10.12.0-2],
	[`10.16`][dockerfile-10.16.3-2],
	[`10.21`, `10`][dockerfile-10.21.0]
-	[`12.8`][dockerfile-12.8.1-2],
	[`12.9`][dockerfile-12.9.1],
	[`12.10`][dockerfile-12.10.0],
	[`12.16`][dockerfile-12.16.2-1],
	[`12.18`, `12`][dockerfile-12.18.2]
-	[`14.5`][dockerfile-14.5.0],
	[`14.15`, `14`, `latest`][dockerfile-14.15.1]


## <a name="tags-dev"></a>Development tags

Tags that used for development purposes and can be (and most likely will be) deleted/rebuilt
at any time

-	`4.8.7-alpha`, `4.8-alpha`, `4-alpha`
-	`6.11.1-alpha`, `6.11-alpha`
-	`8.9.0-alpha`
-	`10.1.0-alpha`
-	`10.16.0-alpha`, `10-alpha`
-	`12.8.1-alpha`


# Quick reference

<!--
-	**Where to get help:**
-	**Published image artifact details**:
-	**Image updates**:
-->

-	**Where to file issues**:
	<br/>[https://github.com/pdffillerdocker/pm2-consul/issues](https://github.com/pdffillerdocker/pm2-consul/issues)

-	**Supported architectures**:
	<br/>`amd64`

-	**Maintained by**:
	<br/>[PDFfiller](https://github.com/pdffillerdocker/pm2-consul)
	<br/>[Anton Trifonov](https://github.com/rinrailin)

-	**Source of this description**:
	<br/>[`README.md` at GitHub](https://github.com/pdffillerdocker/pm2-consul/blob/master/README.md)

# PM2-Consul

PM2-Consul is a Docker image based on [Node.js official docker image](https://hub.docker.com/_/node)
with preinstalled [PM2 process manager](https://pm2.keymetrics.io/) and
[consul-template](https://github.com/hashicorp/consul-template). PM2-Consul image designed to be
used as a base image for dockerization of Node.js applications and to provide additional useful
features "out of the box", such as:

- process management (using PM2)
- wrapping STDOUT and STDERR to logfiles
- consul-template execution and supervision
- logfiles rotation (without copytruncate to be "filebeat compliant")

# Contents

- [Supported tags and respective `Dockerfile` links](#tags)
  - [Immutable tags](#tags-frozen)
  - [Mutable Tags](#tags-stable)
  - [Development Tags](#tags-dev)
- [Quick reference](#quick-reference)
- [PM2-Consul](#pm2-consul)
- [Contents](#contents)
- [How to use this image](#how-to-use-this-image)
  - [Create a `Dockerfile` in your app project](#dockerfile)
  - [Running an application without image building](#docker-compose)
  - [Customization](#customization)
    - [Ecosystem file](#ecosystem-file)
    - [Logs configuration](#logs-configuration)
    - [Logrotate](#logrotate)
    - [Provisioning scripts](#provisioning)
    - [Consul-template](#consul-template)
  - [Paths summary](#paths-summary)
  - [Usage example](#usage-example)
- [Tagging convention](#tagging-convention)
- [License](#license)

# How to use this image

## <a name="dockerfile"></a>Create a `Dockerfile` in your app project

The basic way to use this image is to specify it in `FROM` instruction of your Dockerfile.
This can be done as simple as:

```dockerfile
FROM pdffiller/pm2-consul

COPY . .

RUN npm install

EXPOSE 8080

CMD ["server.js"]
```

You can then build and run the Docker image:

```console
$ docker build -t my-app .
$ docker run -it --rm --name my-running-app my-app
```

Despite this example is fully functional, real applications will likely use additional capabilities
provided by PM2-Consul. See the [Customization](#customization) section below for more information
and examples.

## <a name="docker-compose"></a>Running an application without image building

In some simple, cases you may find it inconvenient to build your own Docker image for your
application. In such cases, you can run your application in PM2-Consul image directly:

```console
$ docker run -it --rm --name my-running-app -v "$PWD":/app --expose 8080 pdffiller/pm2-consul server.js
```

Or if you prefer Docker Compose, create `docker-compose.yml`:

```yml
version: "2"
services:
  app:
    image: "pdffiller/pm2-consul"
    environment:
      - NODE_ENV=production
    volumes:
      - ./:/app
    expose:
      - "8080"
    command: "server.js"
```

And then run using Docker Compose:

```console
$ docker-compose up -d
```

## Customization

### Ecosystem file

The PM2-Consul image can take both Node.js script name or
[PM2 ecosystem file](http://pm2.keymetrics.io/docs/usage/application-declaration/#ecosystem-file)
name as `CMD`. Entrypoint script of PM2-Consul looks at first `CMD` parameter and if it ends with
`.config.js`, `.config.mjs`, `.json`, `.yml` or `.yaml`, considers PM2 ecosystem file name is
passed. In case if the first `CMD` parameter ends with `.js` (but not `.config.js`!), Node.js
script name is considered.

If Node.js script name is passed as `CMD`, [default ecosystem file](https://github.com/pdffillerdocker/pm2-consul/blob/master/files/etc/pm2/ecosystem.config.js)
(located as `/etc/pm2/ecosystem.config.js`) is used to run it. `script` and `name` general
attributes are changed to provided Node.js script name (without ".js" extension for `name`
attribute) before running.

You can use your PM2 ecosystem file when creating `Dockerfile`:

```dockerfile
FROM pdffiller/pm2-consul

COPY . .

RUN npm install && \
    cp -v docker/files/ecosystem.config.js /etc/pm2/

EXPOSE 8080

CMD ["/etc/pm2/ecosystem.config.js"]
```

### Logs configuration

PM2 process manager provides some [log management](http://doc.pm2.io/en/runtime/guide/log-management/)
capabilities, which are also provided by PM2-Consul image in turn. By default, PM2 catches `STDOUT`
and `STDERR` of your application and writes them to files in its default log path. For PM2-Consul
image PM2 default log path set to `/var/log/pm2`.

Logs configuration can be configured with an [ecosystem file](#ecosystem-file). With the default
ecosystem file, the application's out.log, as well as error.log, are written in JSON format.

For log files created and handled by Node.js application itself, special directory `/var/log/nodejs`
created, though it's usage is optional.

For example, if you wish to have direct access to logs of your dockerized application from your
local machine, you can run your application with such `docker-compose.yml`:

```yml
version: "2"
services:
  app:
    image: "pdffiller/pm2-consul"
    environment:
      - NODE_ENV=production
    volumes:
      - ./logs/pm2:/var/log/pm2
      - ./logs/nodejs:/var/log/nodejs
    expose:
      - "8080"
    command: "server.js"
```

and your application's log will be available in the `logs` directory of your project.

### Logrotate

As log files are growing with time, it is a good idea to rotate them. PM2 suggests using the
[pm2-logrotate](https://github.com/keymetrics/pm2-logrotate) module. But it supports only
"copytruncate" behavior, that does not fit well log shippers, such as [filebeat](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-overview.html).

Because of this, PM2-Consul image contains standard UNIX [logrotate](http://man7.org/linux/man-pages/man8/logrotate.8.html)
utility, running as PM2 module.

This logrotate PM2 module has `cron_restart` general attribute set to `55 0 * * *`. Logrotate
configuration placed in [`/etc/logrotate.conf`](https://github.com/pdffillerdocker/pm2-consul/blob/master/files/etc/logrotate.conf)
file and [`/etc/logrotate.d`](https://github.com/pdffillerdocker/pm2-consul/blob/master/files/etc/logrotate.d)
directory. By default only `*.log` and `*.json` files in PM2 default log path are rotated daily.
Log files are compressed (except previous log file for this rotation cycle) and removed after 7
rotations. `/usr/local/bin/pm2 reloadLogs` command is used as `postrotate` script, forcing PM2 to
reopen log files.

Pay attention that log files of Node.js application, placed in `/var/log/nodejs`, are not rotated
with logrotate by default. You may choose to rotate these logs by your logging library/framework or
by logrotate. In the second case, you can place additional logrotate config file in
`/etc/logrotate.d` directory. Keep in mind if your application does not reopen log files
automatically, you must provide a mechanism for forcing your application to reopen log files. This
can be performed by signal handling (as [here](https://github.com/log4js-node/log4js-node/pull/403/files)
in the log4js-node framework).

Let's say for example you have a Node.js application named "server" writing its log to
`/var/log/nodejs/app.log` and reopening this log by receiving `HUP` UNIX signal. To setup rotation
of this log file by logrotate, create logrotate config `docker/files/etc/logrotate.d/nodejs`:

```
/var/log/nodejs/app.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    dateext
    extension .log
    dateformat .%Y-%m-%d_%H-%M-%S
    sharedscripts
    postrotate
        /usr/local/bin/pm2 sendSignal SIGHUP server
    endscript
}
```

And place it into `/etc/logrotate.d` directory of your Docker image:

```dockerfile
FROM pdffiller/pm2-consul

COPY . .

RUN npm install && \
    cp -v docker/files/etc/logrotate.d/nodejs /etc/logrotate.d/

EXPOSE 8080

CMD ["server.js"]
```

### <a name="provisioning"></a>Provisioning scripts

There is a special directory `/provision.d`, which contains provisioning scripts for Docker images,
inherited from PM2-Consul image. During container start, entrypoint script of PM2-Consul (which is a
bash script) sources all `*.sh` files from this directory. Scripts are sourced in alphabetical
order. PM2-Consul image is shipped with one such script &ndash;
[10-log\_path\_setup.sh](https://github.com/pdffillerdocker/pm2-consul/blob/master/files/provision.d/10-log_path_setup.sh),
which templates logrotate config for PM2 logs. You may want to add your provisioning scripts to
this directory.

**Pay attention!** As entrypoint script of PM2-Consul precisely sources provisioning scripts, your
provisioning scripts MUST NOT contain `exit` shell builtin command (even `exit 0`) as it will exit
entire entrypoint script and container start will fail. Also, keep in mind the entrypoint script of
PM2-Consul runs with `set -e`, so your script (and entire entrypoint script) will exit if any
command fails. You can disable this by adding `set +e` at the beginning of your provisioning script.
Entrypoint script will run `set -e` after each sourcing.

### Consul-template

PM2-Consul image is shipped with consul-template preinstalled. It runs as PM2 module and uses
`/etc/consul/consul.hcl` as a config file. Directory `/etc/consul/templates` is for storing
templates. By default, the consul-template config file is of size zero and there are no templates,
so nothing is templated.

If your application needs to be configured with values from Consul, the common way is to use
the [dotenv](https://www.npmjs.com/package/dotenv) Node.js module and to render `.env` file with
consul-template.

You can use `pm2 reload <app_name>` as a template command for updating the configuration of your
application if corresponding keys in Consul change. If your application should perform some actions
before reloading, consider adding [graceful reload support](http://pm2.keymetrics.io/docs/usage/signals-clean-restart/)
to your application.

For example let's say your application, named "server", is using the `dotenv` Node.js module and
expects `DB_HOST`, `DB_USER` and `DB_PASS` variables should be configured from Consul. To make
things work, just create in your project template file
`docker/files/etc/consul/templates/env.ctmpl`:

```liquid
DB_HOST={{ printf "%s/db/host" (env "KV_PATH") | key }}
DB_USER={{ printf "%s/db/user" (env "KV_PATH") | key }}
DB_PASS={{ printf "%s/db/pass" (env "KV_PATH") | key }}
```

and consul-template configuration file `docker/files/etc/consul/consul.hcl`:

```hcl
template {
  source = "/etc/consul/templates/env.ctmpl"
  destination = "/app/.env"

  command = "pm2 reload server"
}
```

and copy them to appropriate places of your Docker image:

```dockerfile
FROM pdffiller/pm2-consul

COPY . .

RUN npm install && \
    cp -Rvp docker/files/etc/consul/* /etc/consul/

EXPOSE 8080

CMD ["server.js"]
```

Do not forget to set `CONSUL_HTTP_ADDR` and other environment variables, used by consul-template,
to correct values when running your Docker image.

## Paths summary

- `/pm2` &ndash; PM2 home directory
- `/etc/pm2/ecosystem.config.js` &ndash; default ecosystem file
- `/var/log/pm2` &ndash; directory for PM2 default log path
- `/var/log/nodejs` &ndash; directory for logs managed by Node.js application itself
- `/provision.d` &ndash; directory for provisioning scripts
- `/etc/consul/consul.hcl` &ndash; consul-template configuration file
- `/etc/consul/templates` &ndash; directory for templates
- `/etc/logrotate.d` &ndash; directory for logrotate configuration files
- `/app` &ndash; application home directory

## Usage example

In the [`example`](https://github.com/pdffillerdocker/pm2-consul/blob/master/example)
folder of this repository, you can find an example of dockerizing simple Node.js application with
PM-Consul Docker image. Also graceful restart, applications log file reopening for logrotate
support and usage KV from Consul are shown there.

# Tagging convention

PM2-Consul has a variety of image versions/variants with different tags. Although tags are often
confused with versions, this is a misconception and is not true. Tags are not versions in the
general sense, because it is possible to rebuild the image with a specific tag. For convenience,
tags are often made to correspond to certain versions, but you can not argue that some Docker image
with some tag is the same as three months before. So it is a good idea to describe some
"tagging principles" to make clear for those, who will use this Docker image, what to expect
from a particular tag.

PM2-Consul Docker image consists of two main logical parts, which are versioned independently:

- Node.js official docker image, on which PM2-Consul is based;
- additional configs and own PM2-Consul's `Dockerfile`.

As the main purpose of PM2-Consul image is to be used for the dockerization of Node.js
applications, it was decided to use Node.js version as a tag, to be convenient for PM2-Consul image
consumers.

Also the concept of *"supported versions"* is used. Here "supported versions" are versions of
Node.js for which new PM2-Consul Docker images will be built in case of PM2-Consul's `Dockerfile`
and/or additional configs change. For now supported Node.js versions are:

- 8.16.1
- 10.1.0
- 10.12.0
- 10.16.3
- 12.8.1
- 12.16.2

This list can be (and will be) changed with time.

PM2-Consul Docker image tags are divided into three groups:
- [**Immutable tags**](#tags-frozen)

  Tags of the form **`N.N.N`** or **`N.N.N-N`**, where **N** is a number.

  Images with immutable tags should be built only once and should not be rebuilt/retagged in normal
  cases (an example of an abnormal case might be a docker registry crash or something similar).

- [**Mutable Tags**](#tags-stable)

  Tags of the form **`N.N`**, **`N`** or **`latest`**.

  Mutable tags can be assigned and reassigned to different images. Ordinarily, such tags will be
  assigned to most recent images, built with the latest minor, latest major and latest versions of
  Node.js correspondently.

- [**Development Tags**](#tags-dev)

  Any other tags (e.g. **`8.9.0-alpha`** etc).

  Images with such tags are used for development, testing, and other similar purposes. Such
  images can be (and most likely will be) deleted at any time. You do not want to use such
  images.

When new significant changes occur in PM2-Consul's code (`Dockerfile`, configs, etc) new Docker
images for all supported versions are built. If an image with an immutable tag already exists for
specific Node.js version, newly built image is tagged with the next free tag with **`-N`** suffix,
where N is a number, starting from 1. So images with `10.16.2` version of Node.js will have tags
`10.16.3`, `10.16.3-1`, `10.16.3-2`, `10.16.3-3` and so on. And the `10.16.3-2` image is newer than
`10.16.3-1`, and they both are newer than `10.16.3`.

Simultaneously mutable tags are assigned the to most recent corresponding immutable tag. E.g.
`10.16` tag chronologically points to `10.16.0`, `10.16.0-1`, `10.16.0-2`, `10.16.1`, `10.16.1-1`,
`10.16.2` and so on.

When choosing which tag to use, it is recommended to use mutable tags at the start for developing,
as this will allow using the latest, most recent features. When the application goes to production
it will be better to use immutable tags for builds, as this will be more stable and predictable.

# License

pdffiller/pm2-consul is **licensed** under the [**MIT License**](https://github.com/pdffillerdocker/pm2-consul/blob/master/LICENSE).
